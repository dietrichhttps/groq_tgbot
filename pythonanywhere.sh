#!/bin/bash

# PythonAnywhere Deployment Script for Groq Telegram Bot

set -e  # Exit on error

echo "ðŸš€ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Telegram Ð±Ð¾Ñ‚Ð° Ð½Ð° PythonAnywhere..."

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ†Ð²ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð²Ñ‹Ð²Ð¾Ð´Ð°
log_info() {
    echo -e "${GREEN}â„¹ï¸  $1${NC}"
}

log_warn() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð½Ð° PythonAnywhere
if ! grep -q "pythonanywhere" "$HOME/.bashrc" 2>/dev/null && [ -z "$PYTHONANYWHERE_SITE" ]; then
    log_warn "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð½Ð° PythonAnywhere"
    log_warn "Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚Ðµ ÐµÐ³Ð¾ Ð² PythonAnywhere Bash ÐºÐ¾Ð½ÑÐ¾Ð»Ð¸"
    read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "ÐžÑ‚Ð¼ÐµÐ½Ð° Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ"
        exit 1
    fi
fi

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ PythonAnywhere
PYTHONANYWHERE_USERNAME=$(basename "$HOME")
log_info "Ð˜Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: $PYTHONANYWHERE_USERNAME"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
if [ ! -f "bot.py" ]; then
    log_error "Ð¤Ð°Ð¹Ð» bot.py Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    exit 1
fi

if [ ! -f "requirements.txt" ]; then
    log_error "Ð¤Ð°Ð¹Ð» requirements.txt Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð° ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
BOT_DIR="$HOME/groq-tgbot"
if [ -d "$BOT_DIR" ]; then
    log_warn "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ $BOT_DIR ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
    read -p "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°Ð½Ð¾Ð²Ð¾? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -rf "$BOT_DIR"
        log_info "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð°"
    else
        log_info "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ"
    fi
fi

mkdir -p "$BOT_DIR"
log_info "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°: $BOT_DIR"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
log_info "ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
cp bot.py requirements.txt .env.example "$BOT_DIR/"
log_info "Ð¤Ð°Ð¹Ð»Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cd "$BOT_DIR"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
if [ ! -d "venv" ]; then
    python3.10 -m venv venv
    log_info "Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾"
else
    log_info "Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
fi

# ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
log_info "ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
source venv/bin/activate

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ pip
log_info "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ pip..."
pip install --upgrade pip

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
log_info "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pip install -r requirements.txt
log_info "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
if [ ! -f ".env" ]; then
    log_warn "Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
    log_info "Ð¡Ð¾Ð·Ð´Ð°ÑŽ .env Ð¸Ð· .env.example..."
    cp .env.example .env
    log_warn "âš ï¸  Ð’ÐÐ–ÐÐž: ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» .env Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð²Ð°ÑˆÐ¸ Ñ‚Ð¾ÐºÐµÐ½Ñ‹!"
    echo "ðŸ“ ÐŸÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ: $BOT_DIR/.env"
    echo "ðŸ“ ÐÑƒÐ¶Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ:"
    echo "   - TELEGRAM_BOT_TOKEN (Ð¾Ñ‚ @BotFather)"
    echo "   - GROQ_API_KEY (Ð¾Ñ‚ console.groq.com)"
    echo ""
    read -p "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð¿Ð¾ÑÐ»Ðµ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ .env Ñ„Ð°Ð¹Ð»Ð°..."
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½Ñ‹ Ð² .env
log_info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
source .env

if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ "$TELEGRAM_BOT_TOKEN" = "your_telegram_bot_token_here" ]; then
    log_error "TELEGRAM_BOT_TOKEN Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½!"
    echo "ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»: $BOT_DIR/.env"
    exit 1
fi

if [ -z "$GROQ_API_KEY" ] || [ "$GROQ_API_KEY" = "your_groq_api_key_here" ]; then
    log_error "GROQ_API_KEY Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½!"
    echo "ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»: $BOT_DIR/.env"
    exit 1
fi

log_info "âœ… Ð¢Ð¾ÐºÐµÐ½Ñ‹ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"

# Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð² ÐºÐ¾Ð½ÑÐ¾Ð»Ð¸
log_info "Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð° (Ctrl+C Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸)..."
echo "ðŸ” Ð•ÑÐ»Ð¸ Ð±Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾, Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ctrl+C"
read -p "Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹ Ðº Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¼Ñƒ Ð·Ð°Ð¿ÑƒÑÐºÑƒ? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ PythonAnywhere
    export PYTHONANYWHERE=true
    timeout 10s python3.10 -u bot.py || {
        log_warn "Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ (ÑÑ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Always-On Ð·Ð°Ð´Ð°Ñ‡Ð¸)"
    }
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Always-On Ð·Ð°Ð´Ð°Ñ‡Ð¸
log_info "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´Ð»Ñ Always-On Ð·Ð°Ð´Ð°Ñ‡Ð¸..."
cat > run_bot.sh << 'EOF'
#!/bin/bash
cd /home/$PYTHONANYWHERE_USERNAME/groq-tgbot
source venv/bin/activate
export PYTHONANYWHERE=true
python3.10 -u bot.py
EOF

chmod +x run_bot.sh
log_info "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ run_bot.sh ÑÐ¾Ð·Ð´Ð°Ð½"

# Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸ÑŽ Always-On Ð·Ð°Ð´Ð°Ñ‡Ð¸
echo ""
log_info "ðŸŽ¯ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ:"
echo ""
echo "1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ PythonAnywhere Dashboard"
echo "2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ñ€Ð°Ð·Ð´ÐµÐ» 'Tasks'"
echo "3. ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‚Ð¸Ñ‚Ðµ Ð²Ð½Ð¸Ð· Ð´Ð¾ 'Always-on tasks'"
echo "4. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Add an always-on task'"
echo ""
echo "ðŸ“‹ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Always-On Ð·Ð°Ð´Ð°Ñ‡Ð¸:"
echo "   Command: /home/$PYTHONANYWHERE_USERNAME/groq-tgbot/run_bot.sh"
echo "   Description: Groq Telegram Bot"
echo "   Minute: */1 (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ)"
echo ""
echo "5. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Create'"
echo ""
echo "ðŸ“Š ÐŸÐ¾ÑÐ»Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Always-On Ð·Ð°Ð´Ð°Ñ‡Ð¸:"
echo "   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ Always-on tasks"
echo "   - Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑ 'Running'"
echo "   - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð±Ð¾Ñ‚Ð° Ð² Telegram"
echo ""
echo "ðŸ” ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "   tail -f /home/$PYTHONANYWHERE_USERNAME/groq-tgbot/run_bot.log"
echo "   cd /home/$PYTHONANYWHERE_USERNAME/groq-tgbot && source venv/bin/activate && python3.10 -u bot.py"
echo ""
log_info "âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾! Ð‘Ð¾Ñ‚ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐµ Always-On Ð·Ð°Ð´Ð°Ñ‡Ð¸."