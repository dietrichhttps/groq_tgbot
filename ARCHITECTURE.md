# Архитектура ChatGPT Telegram Bot

## Обзор

ChatGPT Telegram Bot - это приложение на Python, которое интегрирует Telegram Bot API с OpenAI ChatGPT для предоставления интерактивного чат-интерфейса.

## Структура проекта

```
chatgpt_tgbot/
├── bot.py                 # Основной файл с обработчиками команд и сообщений
├── config.py              # Конфигурация и загрузка переменных окружения
├── dialogue_manager.py    # Управление историей диалогов пользователей
├── chatgpt_client.py      # Клиент для работы с OpenAI API
├── requirements.txt       # Зависимости Python
├── .env.example          # Шаблон переменных окружения
├── .gitignore            # Git ignore правила
├── README.md             # Основная документация
├── SETUP.md              # Инструкции по установке и запуску
├── EXAMPLES.md           # Примеры использования
├── ARCHITECTURE.md       # Этот файл (описание архитектуры)
└── test_bot.py           # Модульные тесты
```

## Компоненты системы

### 1. bot.py - Главный модуль

Основной файл приложения, содержит:

**Функции обработчиков:**
- `start_command()` - Обработчик команды `/start`
  - Очищает историю диалога пользователя
  - Показывает приветственное сообщение
  - Отображает кнопку "Новый запрос"

- `help_command()` - Обработчик команды `/help`
  - Показывает справку по использованию бота
  - Список доступных команд и советы

- `reset_context()` - Обработчик кнопки "Новый запрос"
  - Очищает историю диалога текущего пользователя
  - Подтверждает пользователю очистку контекста

- `handle_message()` - Обработчик текстовых сообщений
  - Сохраняет сообщение пользователя в историю
  - Получает ответ от ChatGPT через ChatGPTClient
  - Сохраняет ответ в историю
  - Отправляет ответ пользователю
  - Обрабатывает ошибки API

- `main()` - Главная функция
  - Инициализирует приложение Telegram
  - Регистрирует обработчики команд
  - Запускает polling для получения сообщений

### 2. config.py - Конфигурация

Управляет конфигурацией приложения:

**Класс Config:**
- `TELEGRAM_BOT_TOKEN` - Токен Telegram бота
- `OPENAI_API_KEY` - API ключ OpenAI
- `OPENAI_MODEL` - Модель ChatGPT (по умолчанию gpt-3.5-turbo)
- `LOG_LEVEL` - Уровень логирования (по умолчанию INFO)
- `LOG_FORMAT` - Формат логов
- `validate()` - Проверка наличия необходимых переменных окружения

**Функции:**
- `setup_logging()` - Инициализирует логирование

### 3. dialogue_manager.py - Управление диалогами

Управляет историей диалогов для каждого пользователя:

**Класс DialogueManager:**
- `conversations` - Словарь с историей диалогов (user_id -> список сообщений)

**Методы:**
- `add_message(user_id, role, content)` - Добавляет сообщение в историю
- `get_history(user_id)` - Возвращает полную историю для пользователя
- `clear_history(user_id)` - Очищает историю пользователя
- `has_history(user_id)` - Проверяет наличие истории
- `get_history_length(user_id)` - Возвращает количество сообщений

**Формат сообщения:**
```python
{
    "role": "user" | "assistant",
    "content": "текст сообщения"
}
```

### 4. chatgpt_client.py - Клиент OpenAI

Обрабатывает взаимодействие с OpenAI API:

**Класс ChatGPTClient:**
- Инициализирует OpenAI клиент с API ключом
- Использует модель, указанную в конфигурации

**Методы:**
- `get_response(messages)` - Получает ответ от ChatGPT
  - Принимает список сообщений с контекстом
  - Возвращает текст ответа
  - Обрабатывает ошибки аутентификации и rate limiting

## Поток данных

```
Telegram User
    ↓
Telegram API
    ↓
bot.py (handle_message)
    ↓
dialogue_manager.add_message() [сохранить запрос]
    ↓
dialogue_manager.get_history() [получить контекст]
    ↓
chatgpt_client.get_response() [запрос к OpenAI]
    ↓
OpenAI API
    ↓
chatgpt_client (ответ)
    ↓
dialogue_manager.add_message() [сохранить ответ]
    ↓
bot.py (отправить ответ)
    ↓
Telegram API
    ↓
Telegram User
```

## Управление состоянием

### Хранение истории

- История хранится в памяти (в переменной `dialogue_manager.conversations`)
- Ключ: user_id (целое число)
- Значение: список словарей с сообщениями

### Очистка контекста

История очищается в следующих случаях:
1. Команда `/start`
2. Нажатие кнопки "Новый запрос"
3. Перезагрузка приложения (история теряется)

### Многопользовательская поддержка

- Каждый пользователь имеет свой user_id
- Истории полностью независимы друг от друга
- Одновременно может общаться несколько пользователей

## Обработка ошибок

### Типы ошибок

1. **AuthenticationError** - неверный API ключ
2. **RateLimitError** - превышен лимит запросов
3. **Общие исключения** - другие ошибки

### Обработка

Все ошибки:
- Логируются (logger.error)
- Отправляют дружественное сообщение пользователю
- Не приводят к падению приложения

## Логирование

- Уровень: INFO (по умолчанию), можно изменить через LOG_LEVEL
- Формат: `datetime - module - level - message`
- Вывод: консоль (stdout)

## Зависимости

- `python-telegram-bot==20.3` - Telegram Bot API
- `openai==1.3.9` - OpenAI API клиент
- `python-dotenv==1.0.0` - Управление переменными окружения
- `aiohttp==3.9.1` - Асинхронный HTTP клиент

## Асинхронность

- Приложение использует асинхронное программирование (async/await)
- Все обработчики асинхронные (async def)
- Telegram polling работает асинхронно
- Позволяет обрабатывать несколько пользователей одновременно

## Безопасность

### Что реализовано:
- API ключи хранятся в переменных окружения (.env файл не коммитится)
- Обработка исключений предотвращает раскрытие деталей ошибок

### Что можно улучшить:
- Кэширование результатов для предотвращения дублирующихся запросов
- Rate limiting на уровне приложения
- Шифрование истории диалогов (если сохранять на диск)
- Аутентификация пользователей (если нужна приватность)

## Производительность

### Текущее состояние:
- История хранится в памяти (быстро)
- Один процесс на сервере
- Масштабируется до нескольких тысяч пользователей

### Возможные улучшения:
- Кэширование часто используемых ответов
- Сохранение истории в БД для персистентности
- Использование нескольких процессов/workers

## Расширение функционала

Возможные улучшения:
1. Сохранение истории в БД (SQLite, PostgreSQL)
2. Поддержка разных языков интерфейса
3. Настраиваемые параметры ChatGPT (temperature, max_tokens)
4. Поддержка разных моделей ChatGPT
5. Аналитика использования (количество запросов, статистика)
6. Веб-интерфейс для администрирования
7. Поддержка файлов (изображения, документы)
8. Интеграция с другими сервисами (слуги, переводчик и т.д.)
